<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Poverty Indicators</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <link href='//cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/7.0.0/sanitize.min.css' rel='stylesheet' />
  <link href='//api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.css' rel='stylesheet' />
  <script src="https://www.gstatic.com/firebasejs/5.4.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDJYLrLzQLAfimH3E7Dg9MUayNE_fNfRAY",
    authDomain: "napc-6ec1b.firebaseapp.com",
    databaseURL: "https://napc-6ec1b.firebaseio.com",
    projectId: "napc-6ec1b",
    storageBucket: "napc-6ec1b.appspot.com",
    messagingSenderId: "843999000252"
  };
  firebase.initializeApp(config);
</script>
  <script src='//api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.js'></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
  <script src="//d3js.org/d3.v5.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.min.js'></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.css' type='text/css' />
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px 15px;
      box-shadow: 0 2px 2px rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }
    .indicators {
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }
    .need {
      align-items: center;
      opacity: 0.5;
      cursor: pointer;
      font-size: 0.8em;
    }
    .indicator {
      display: flex;
      align-items: center;
      opacity: 0.5;
      cursor: pointer;
      font-size: 0.7em;
    }
    .indicator:hover {
      opacity: 0.8;
    }
    .indicator:before {
      display: block;
      content: ' ';
      background-color: currentColor;
      width: 0.87em;
      height: 0.87em;
      margin-right: 0.87em;
    }
    .indicator.-selected {
      opacity: 1;
    }
    .tooltip-title {
      font-size: 1.25em;
      font-weight: bold;
    }
    .tooltip-body {
      font-size: 0.80em;
    }
  </style>
</head>
<body>


<div id='map'></div>

<nav class='controls'>
  <ul class='indicators'></ul>
</nav>

<script>
mapboxgl.accessToken = '***REMOVED***'

var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/thinkdatasci/cjlowf4kl65i12roauwxtc3ez',
  center: [121, 14.58],
  minZoom: 8,
  zoom: 10
})

var indicators = [
  {
    'need': 'Food and Land Reform',
    'id': 'food1',
    'label': 'Malnourished Children',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Food and Land Reform',
    'id': 'food2',
    'label': 'Insecure Farmer Tenure',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Water and Sanitation',
    'id': 'water1',
    'label': 'Drinking Water Access',
    'paint': {
      'fill-color': '#10b8cd',
      'fill-opacity': [ 'interpolate', ['linear'], ['get', 'wo_access_drinking_sources_prop'], 0, 0, 100, 1],
      'fill-outline-color': 'white'}
    },
  {
    'need': 'Water and Sanitation',
    'id': 'water2',
    'label': 'Toilet Access',
    'paint': {
      'fill-color': '#10b8cd',
      'fill-opacity': [ 'interpolate', ['linear'], ['get', 'wo_access_toilet_prop'], 0, 0, 100, 1],
      'fill-outline-color': 'white'}
    },
  {
    'need': 'Water and Sanitation',
    'id': 'water3',
    'label': 'Waterworks System Access',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Shelter',
    'id': 'shelter1',
    'label': 'Makeshift Housing',
    'paint': {
      'fill-color': '#ff9138',
      'fill-opacity': [ 'interpolate', ['linear'], ['get', 'salvaged_houses_prop'], 0, 0, 100, 1],
      'fill-outline-color': 'white'}
    },
  {
    'need': 'Shelter',
    'id': 'shelter2',
    'label': 'Informal Settlers',
    'paint': {
      'fill-color': '#ff9138',
      'fill-opacity': [ 'interpolate', ['linear'], ['get', 'squat_prop'], 0, 0, 100, 1],
      'fill-outline-color': 'white'}
    },
  {
    'need': 'Shelter',
    'id': 'shelter3',
    'label': 'Electricity Access',
    'paint': {
      'fill-color': '#ff9138',
      'fill-opacity': [ 'interpolate', ['linear'], ['get', 'no_electricity_prop'], 0, 0, 100, 1],
      'fill-outline-color': 'white'}
    },
  {
    'need': 'Health',
    'id': 'health1',
    'label': 'Health Care Center Attendance',
    'paint': {
      'fill-color': '#438bca',
      'fill-opacity': [ 'interpolate', ['linear'], ['get', 'not_attended_hc_prop'], 0, 0, 100, 1],
      'fill-outline-color': 'white'}
    },
  {
    'need': 'Health',
    'id': 'health2',
    'label': 'Programs and Services Received',
    'paint': {
      'fill-color': '#438bca',
      'fill-opacity': [ 'interpolate', ['linear'], ['get', 'no_serv_received_soc_protection_prop'], 0, 0, 100, 1],
      'fill-outline-color': 'white'}
    },
  {
    'need': 'Health',
    'id': 'health3',
    'label': 'Health Center Access',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Health',
    'id': 'health4',
    'label': 'Hospital Access',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Education',
    'id': 'educ1',
    'label': 'Children Out of School (6-12 yo)',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Education',
    'id': 'educ2',
    'label': 'Children Out of School (13-16 yo)',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Education',
    'id': 'educ3',
    'label': 'Children Out of School (6-16 yo)',
    'paint': {
      'fill-color': '#e93434',
      'fill-opacity': [ 'interpolate', ['linear'], ['get', 'not_schooling_prop'], 0, 0, 100, 1],
      'fill-outline-color': 'white'}
    },
  {
    'need': 'Education',
    'id': 'educ4',
    'label': 'Elementary School Access',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Education',
    'id': 'educ5',
    'label': 'High School Access',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Work',
    'id': 'work1',
    'label': 'Unemployment Rate',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Work',
    'id': 'work2',
    'label': 'Farms, Forestry Workers, or Fisherfolks',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Work',
    'id': 'work3',
    'label': 'Laborers & Unskilled Workers',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Work',
    'id': 'work4',
    'label': 'Predicted Household Income',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Social Protection',
    'id': 'sp1',
    'label': 'SSS / GSIS availment',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Social Protection',
    'id': 'sp2',
    'label': 'PhilHealth, Pantawid, Cash Transfer support',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Peace and Order',
    'id': 'po1',
    'label': 'Crime Victims',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Peace and Order',
    'id': 'po2',
    'label': 'Armed Conflict',
    'paint': {
      'fill-color': '#f7bb09',
      'fill-opacity': [ 'interpolate', ['linear'], ['get', 'affected_prop'], 0, 0, 100, 1],
      'fill-outline-color': 'white'}
    },
  {
    'need': 'Participation',
    'id': 'participation1',
    'label': 'Voter Registration Rate',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Participation',
    'id': 'participation2',
    'label': 'Voter Turnout Rate',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Participation',
    'id': 'participation3',
    'label': 'Barangay Assembly Attendance Rate',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Participation',
    'id': 'participation4',
    'label': 'Cooperative Members',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Healthy Environment',
    'id': 'he1',
    'label': 'Flood Risk',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Healthy Environment',
    'id': 'he2',
    'label': 'Landslide Risk',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Healthy Environment',
    'id': 'he3',
    'label': 'Volcano Eruption Risk',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  },
  {
    'need': 'Healthy Environment',
    'id': 'he4',
    'label': 'Earthquake Risk',
    'paint': {
      'fill-color': '#b4b4b4'
    }
  }
]

map.on('load', function () {

  // add dataset 
  map.addSource('barangays', {
    'type': 'vector',
    'url': 'mapbox://thinkdatasci.2h2dq70z'
  })

  // add layer
  map.addLayer({
    'id': 'barangays',
    'source': 'barangays',
    'source-layer': 'indicators_geo-9jhdlv',
    'type': 'fill'
  }, 'admin')

})

function addControls () {
  var nested_indicators = d3.nest()
    .key(function (d) {return d.need})
    .entries(indicators)

  var controlIndicators = d3.select('.indicators')
    .selectAll('li')
    .data(nested_indicators)
    .enter()
      .append('li')
      .classed('need', true)
      .text(function (d) { return d.key })
      .append('ul')
      .classed('indicators', true)
      .selectAll('li')
      .data(function (d) { return d.values })
      .enter()
        .append('li')
        .classed('indicator', true)
        .text(function (d) { return d.label })
        .style('color', function (d) { return d.paint['fill-color'] })
        .on('click', function (d) {
          selectIndicator(d.id)
        })

  function selectIndicator (id) {
    var indicator = indicators.find(function (d) { return d.id === id })
    Object.keys(indicator.paint).forEach(function (property) {
      //map.setPaintProperty('municities', property, indicator.paint[property])
      map.setPaintProperty('barangays', property, indicator.paint[property])
    })
    controlIndicators
      .classed('-selected', function (d) { return d.id === id })
  }

  selectIndicator('water1')
}


function showPopups () {

  var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
  });

  map.on('mousemove', 'barangays', function(e){
    map.getCanvas().style.cursor = 'pointer';

    var brgy_data = e.features[0].properties
    var coordinates = e.lngLat
    var description = 
    '<div class = "tooltip-title">'+brgy_data.Bgy_Name+', '+brgy_data.Mun_Name+'</div>'+
    '<div class = "tooltip-body">'+'Water and Sanitation (Drinking Sources): '+brgy_data.wo_access_drinking_sources_prop.toFixed(2)+
    '<br>Water and Sanitation (Toilet): '+brgy_data.wo_access_toilet_prop.toFixed(2)+
    '<br>Shelter (Roof and Outer Wall): '+brgy_data.salvaged_houses_prop.toFixed(2)+
    '<br>Shelter (Tenure): '+brgy_data.squat_prop.toFixed(2)+
    '<br>Shelter (Electricity): '+brgy_data.no_electricity_prop.toFixed(2)+
    '<br>Health (Programs and Services Received): '+brgy_data.no_serv_received_soc_protection_prop.toFixed(2)+
    '<br>Health (Attended Health Centers): '+brgy_data.not_attended_hc_prop.toFixed(2)+
    '<br>Education (Attending vs. Not): '+brgy_data.not_schooling_prop.toFixed(2)+
    '<br>Peace and Order (Displacement): '+brgy_data.affected_prop.toFixed(2)+'</div>';

    popup.setLngLat(coordinates)
      .setHTML(description)
      .addTo(map);
  });

  map.on('mouseleave', 'barangays', function() {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });
}

map.on('load', addControls)
map.on('load', showPopups);

map.addControl(new MapboxGeocoder({
    accessToken: mapboxgl.accessToken
}));

</script>

</body>
</html>
