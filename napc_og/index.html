<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Poverty Indicators</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <link href='//cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/7.0.0/sanitize.min.css' rel='stylesheet' />
  <link href='//api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.css' rel='stylesheet' />
  <script src="https://www.gstatic.com/firebasejs/5.4.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyDJYLrLzQLAfimH3E7Dg9MUayNE_fNfRAY",
    authDomain: "napc-6ec1b.firebaseapp.com",
    databaseURL: "https://napc-6ec1b.firebaseio.com",
    projectId: "napc-6ec1b",
    storageBucket: "napc-6ec1b.appspot.com",
    messagingSenderId: "843999000252"
  };
  firebase.initializeApp(config);
</script>
  <script src='//api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.js'></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
  <script src="//d3js.org/d3.v5.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.min.js'></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.css' type='text/css' />
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px 15px;
      box-shadow: 0 2px 2px rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }
    .indicators {
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }
    .need {
      align-items: center;
      opacity: 0.5;
      cursor: pointer;
      font-size: 0.8em;
    }
    .indicator {
      display: flex;
      align-items: center;
      opacity: 0.3;
      cursor: pointer;
      font-size: 0.7em;
    }
    .indicator:hover {
      opacity: 0.8;
    }
    .indicator:before {
      display: block;
      content: ' ';
      background-color: currentColor;
      width: 0.87em;
      height: 0.87em;
      margin-right: 0.87em;
    }
    .indicator.-selected {
      opacity: 1;
    }
    .tooltip-title {
      font-size: 1.25em;
      font-weight: bold;
    }
    .tooltip-body {
      font-size: 0.80em;
    }
  </style>
</head>
<body>


<div id='map'></div>

<nav class='controls'>
  <ul class='indicators'></ul>
</nav>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoidGhpbmtkYXRhc2NpIiwiYSI6ImNqbHBjeTVyODBlYWszd252ZW1uZjJ2em0ifQ._e3iSO48VFAFXVimrabYEA'

var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/thinkdatasci/cjlowf4kl65i12roauwxtc3ez',
  center: [121, 14.58],
  minZoom: 3,
  zoom: 10
})

var min = 0
var max = 100


var indicators = [
    {
    'need': 'Food and Land Reform',
    'id': 'food',
    'label': 'Insecure Farmer Tenure',
    'main_col': '#86c440',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'Food_Prop'], null], '#ededed',
                      ['!=', ['get', 'Food_Prop'], null], '#86c440', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'Food_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'Food_Prop'], 0, 0, 100, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'Food_Prop'], 16.2921, 0, 83.3187, 1]
                      },
      'fill-outline-color': 'white'}
    },
    {
    'need': 'Water and Sanitation',
    'id': 'water',
    'label': 'Drinking Water Access',
    'main_col': '#438cca',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'Water_Prop'], null], '#ededed',
                      ['!=', ['get', 'Water_Prop'], null], '#438cca', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'Water_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'Water_Prop'], 0, 0, 98.924941, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'Water_Prop'], 0.74839, 0, 83.8662, 1]
                      },
      'fill-outline-color': 'white'}
    },
    {
    'need': 'Shelter',
    'id': 'shelter',
    'label': 'Informal Settlers',
    'main_col': '#f5bb18',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'Shelter_Prop'], null], '#ededed',
                      ['!=', ['get', 'Shelter_Prop'], null], '#f5bb18', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'Shelter_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'Shelter_Prop'], 0, 0, 51.645035, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'Shelter_Prop'], 0.39201, 0, 12.36044, 1]
                      },
      'fill-outline-color': 'white'}
    },
    {
    'need': 'Health',
    'id': 'health',
    'label': 'Health Care Center Non-Attendance',
    'main_col': '#e74b36',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'Health_Prop'], null], '#ededed',
                      ['!=', ['get', 'Health_Prop'], null], '#e74b36', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'Health_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'Health_Prop'], 1.143889, 0, 99.84029, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'Health_Prop'], 22.4498, 0, 91.2211, 1]
                      },
      'fill-outline-color': 'white'}
    },  
    {
    'need': 'Education',
    'id': 'education',
    'label': 'Out of School',
    'main_col': '#177c9f',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'Education_Prop'], null], '#ededed',
                      ['!=', ['get', 'Education_Prop'], null], '#177c9f', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'Education_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'Education_Prop'], 0, 0, 82.914259, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'Education_Prop'], 2.0654, 0, 32.28129, 1]
                      },
      'fill-outline-color': 'white'}
    },
    {
    'need': 'Work',
    'id': 'work',
    'label': 'Unemployment Rate',
    'main_col': '#a03054',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'Work_Prop'], null], '#ededed',
                      ['!=', ['get', 'Work_Prop'], null], '#a03054', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'Work_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'Work_Prop'], 6.451613, 0, 72.229487, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'Work_Prop'], 36.30473, 0, 62.17391, 1]
                      },
      'fill-outline-color': 'white'}
    },
    {
    'need': 'Social Protection',
    'id': 'sp',
    'label': 'SSS Non-Availment',
    'main_col': '#f7903d',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'SocialProtection_Prop'], null], '#ededed',
                      ['!=', ['get', 'SocialProtection_Prop'], null], '#f7903d', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'SocialProtection_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'SocialProtection_Prop'], 91.66117, 0, 99.9569, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'SocialProtection_Prop'], 95.31721, 0, 99.66458, 1]
                      },
      'fill-outline-color': 'white'}
    },
    {
    'need': 'Peace',
    'id': 'peace',
    'label': 'Displacement',
    'main_col': '#10b9cd',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'Peace_Prop'], null], '#ededed',
                      ['!=', ['get', 'Peace_Prop'], null], '#10b9cd', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'Peace_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'Peace_Prop'], 0, 0, 92.9334, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'Peace_Prop'], 0.4685, 0, 48.83817, 1]
                      },
      'fill-outline-color': 'white'}
    },
    {
    'need': 'Participation',
    'id': 'participation',
    'label': 'Barangay Assembly Non-Attendance',
    'main_col': '#a09288',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'Participation_Prop'], null], '#ededed',
                      ['!=', ['get', 'Participation_Prop'], null], '#a09288', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'Participation_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'Participation_Prop'], 57.12506, 0, 99.79317, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'Participation_Prop'], 84.72165, 0, 98.9982, 1]
                      },
      'fill-outline-color': 'white'}
    },
    {
    'need': 'Healthy Environment',
    'id': 'environment',
    'label': 'Risk Score',
    'main_col': '#d4d639',
    'paint': {
      'fill-color': ['case', 
                      ['==', ['get', 'Environment_Prop'], null], '#ededed',
                      ['!=', ['get', 'Environment_Prop'], null], '#d4d639', '#ededed'],
      'fill-opacity': {
                     'barangays': [ 'interpolate', ['linear'], ['get', 'Environment_Prop'], 0, 0, 100, 1], 
                     'municities': [ 'interpolate', ['linear'], ['get', 'Environment_Prop'], 0, 0, 100, 1], 
                     'provinces': [ 'interpolate', ['linear'], ['get', 'Environment_Prop'], 1.697114, 0, 38.12232, 1]
                      },
      'fill-outline-color': 'white'}
    },
]

map.on('load', function () {

  map.addSource('municities', {
    'type': 'vector',
    'url': 'mapbox://thinkdatasci.521iq43v'
  })
  map.addLayer({
    'id': 'municities',
    'source': 'municities',
    'source-layer': 'final-mun-indicators-5hkam3',
    'minzoom': 8,
    'maxzoom': 10,
    'type': 'fill',
  }, 'admin')

  map.addSource('barangays', {
    'type': 'vector',
    'url': 'mapbox://thinkdatasci.6p3k95vf'
  })
  map.addLayer({
    'id': 'barangays',
    'source': 'barangays',
    'source-layer': 'final-bgy-indicators-d0c3va',
    'minzoom': 10,
    'type': 'fill',
  }, 'admin')

  map.addSource('provinces', {
    'type': 'vector',
    'url': 'mapbox://thinkdatasci.dw2nwjoi'
  })
  map.addLayer({
    'id': 'provinces',
    'source': 'provinces',
    'source-layer': 'final-prov-indicators-d637x8',
    'maxzoom': 8,
    'type': 'fill',
  }, 'admin')

})

function addControls () {
  var nested_indicators = d3.nest()
    .key(function (d) {return d.need})
    .entries(indicators)

  var controlIndicators = d3.select('.indicators')
    .selectAll('li')
    .data(nested_indicators)
    .enter()
      .append('li')
      .classed('need', true)
      .text(function (d) { return d.key })
      .append('ul')
      .classed('indicators', true)
      .selectAll('li')
      .data(function (d) { return d.values })
      .enter()
        .append('li')
        .classed('indicator', true)
        .text(function (d) { return d.label })
        .style('color', function (d) { return d.main_col })
        .on('click', function (d) {
          selectIndicator(d.id)
        })

  function selectIndicator (id) {

    var indicator = indicators.find(function (d) { return d.id === id })

      map.setPaintProperty('municities', 'fill-outline-color', indicator.paint['fill-outline-color'])
      map.setPaintProperty('barangays', 'fill-outline-color', indicator.paint['fill-outline-color'])
      map.setPaintProperty('provinces', 'fill-outline-color', indicator.paint['fill-outline-color'])

      map.setPaintProperty('municities', 'fill-color', indicator.paint['fill-color'])
      map.setPaintProperty('barangays', 'fill-color', indicator.paint['fill-color'])
      map.setPaintProperty('provinces', 'fill-color', indicator.paint['fill-color'])

      map.setPaintProperty('municities', 'fill-opacity', indicator.paint['fill-opacity']['municities'])
      map.setPaintProperty('barangays', 'fill-opacity', indicator.paint['fill-opacity']['barangays'])
      map.setPaintProperty('provinces', 'fill-opacity', indicator.paint['fill-opacity']['provinces'])

    controlIndicators
      .classed('-selected', function (d) { return d.id === id })
  }
  console.log(map.getSource('provinces'))
  selectIndicator('water')
}


function showPopups () {

  var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
  });

  map.on('mousemove', 'provinces', function(e){
    map.getCanvas().style.cursor = 'pointer';
    var brgy_data = e.features[0].properties
    
    var coordinates = e.lngLat
    var description = 
    '<div class = "tooltip-title">Province<br>'+brgy_data.Pro_Name+'</div>'+
    '<div class = "tooltip-body">'+ 
    '<br>Food: '+brgy_data.Food_Prop+
    '<br>Water: '+brgy_data.Water_Prop+
    '<br>Shelter: '+brgy_data.Shelter_Prop+
    '<br>Health: '+brgy_data.Health_Prop+
    '<br>Education: '+brgy_data.Education_Prop+
    '<br>Work: '+brgy_data.Work_Prop+
    '<br>Social Protection: '+brgy_data.SocialProtection_Prop+
    '<br>Peace: '+brgy_data.Peace_Prop+
    '<br>Participation: '+ brgy_data.Participation_Prop+
    '<br>Environment: '+brgy_data.Environment_Prop+'</div>';

    popup.setLngLat(coordinates)
      .setHTML(description)
      .addTo(map);
  });

  map.on('mouseleave', 'provinces', function() {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

  map.on('mousemove', 'municities', function(e){
    map.getCanvas().style.cursor = 'pointer';
    var brgy_data = e.features[0].properties
    
    var coordinates = e.lngLat
    var description = 
    '<div class = "tooltip-title">Municipality/City<br>'+brgy_data.Mun_Name+'</div>'+
    '<div class = "tooltip-body">'+ 
    '<br>Food: '+brgy_data.Food_Prop+
    '<br>Water: '+brgy_data.Water_Prop+
    '<br>Shelter: '+brgy_data.Shelter_Prop+
    '<br>Health: '+brgy_data.Health_Prop+
    '<br>Education: '+brgy_data.Education_Prop+
    '<br>Work: '+brgy_data.Work_Prop+
    '<br>Social Protection: '+brgy_data.SocialProtection_Prop+
    '<br>Peace: '+brgy_data.Peace_Prop+
    '<br>Participation: '+ brgy_data.Participation_Prop+
    '<br>Environment: '+brgy_data.Environment_Prop+'</div>';

    popup.setLngLat(coordinates)
      .setHTML(description)
      .addTo(map);
  });

  map.on('mouseleave', 'municities', function() {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

  map.on('mousemove', 'barangays', function(e){
    map.getCanvas().style.cursor = 'pointer';
    var brgy_data = e.features[0].properties
    
    var coordinates = e.lngLat
    var description = 
    '<div class = "tooltip-title">Barangay<br>'+brgy_data.Bgy_Name+'</div>'+
    '<div class = "tooltip-body">'+ 
    '<br>Food: '+brgy_data.Food_Prop+
    '<br>Water: '+brgy_data.Water_Prop+
    '<br>Shelter: '+brgy_data.Shelter_Prop+
    '<br>Health: '+brgy_data.Health_Prop+
    '<br>Education: '+brgy_data.Education_Prop+
    '<br>Work: '+brgy_data.Work_Prop+
    '<br>Social Protection: '+brgy_data.SocialProtection_Prop+
    '<br>Peace: '+brgy_data.Peace_Prop+
    '<br>Participation: '+ brgy_data.Participation_Prop+
    '<br>Environment: '+brgy_data.Environment_Prop+'</div>';

    popup.setLngLat(coordinates)
      .setHTML(description)
      .addTo(map);
  });

  map.on('mouseleave', 'barangays', function() {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });
}

map.on('load', addControls)
map.on('load', showPopups);
map.addControl(new MapboxGeocoder({
    accessToken: mapboxgl.accessToken
}));

</script>

</body>
</html>
